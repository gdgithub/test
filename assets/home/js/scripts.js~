$(document).ready(function(){

    var lemail = $(".login-form #temail");
    var lpassword = $(".login-form #tpass");
    var spassword = $(".register-form #tpass");
    var semail = $(".register-form #temail");
    var authAlert = $("#authAlert");



    getAllContacts();

    // init
    // default element attr and properties
    authAlert.hide();

    

    $('.message a, #register').click(function(){
        $('form').animate({height: "toggle", opacity: "toggle"}, "slow");
    });

    
    $(".login-form button, .register-form button").click(function(){

       // $(".login-form").submit();
    });


    // Log In
    $("#logIn-btn").click(function(e){

        e.preventDefault();

        if(lemail.val().length == 0 || lpassword.val().length == 0)
        {
            authAlert.html("Campos incompletos.");
            authAlert.attr("class","alert alert-warning");
            authAlert.show();
        }
        else
        {
            var dict = {
                email: lemail.val(),
                password: lpassword.val(),
                csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val()
            }

            postData("authenticate/login/",dict,function(data){

                if(data.success)
                {
                  location.reload();
                }
                else if(data.fail)
                { 
                  authAlert.attr("class","alert alert-warning");
                  authAlert.html("Usuario y/o contrasena incorrectos.");
                  authAlert.show();
                }
            });
        }
    });

    //Sig up 
    $("#signUp-btn").click(function(e){

        e.preventDefault();

        if(semail.val().length == 0 || spassword.val().length == 0)
        {
            authAlert.html("Campos incompletos.");
            authAlert.attr("class","alert alert-warning");
            authAlert.show();
        }
        else
        {
            var dict = {
                email: semail.val(),
                password: spassword.val(),
                csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val()
            }

            postData("authenticate/signup/",dict,function(data){

                if(data.exists)
                {
                    authAlert.attr("class","alert alert-warning");
                    authAlert.html("El usuario ya posee una cuenta de acceso.");
                    authAlert.show();
                }
                else if(data.success)
                { 
                    authAlert.attr("class","alert alert-success");
                    authAlert.html("El registro se ha realizado exitosamente, por favor valide su cuenta.");
                    authAlert.show();
                }
                else if(data.fail)
                {
                    authAlert.attr("class","alert alert-danger");
                    authAlert.html(data.fail);
                    authAlert.show();
                }
                else{
                    authAlert.hide();
                }
            });
        }
    });

    $(".message").click(function(){
        authAlert.hide();
    });



    $(".ui.rating").click(function(){
        var a = $('.ui.rating').rating('get rating');

        alert(a);
    });

    $('.ui.dropdown')
      .dropdown()
    ;

    $('.ui.button')
      .popup({
      });


    $('.ui.modal')
        .modal();
    });

$('.menu .item')
  .tab()
;

$('.tabular.menu .item').tab();


function getAllContacts()
{
    var dic = {
        csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val()
    }

    postData('directories/getAll/',dic,function(data){
        createDirectoriesTableWithData($.parseJSON(data));
    });
}

function createDirectoriesTableWithData(data)
{
    console.log(data);
    if(data.length == 0)
    {
        console.log("The array is empty.");
        return false;
    }

    fields = Object.keys(data[0]);

    var parent_table = $(".directories_tb");

    parent_table.html("");

    var html;

    var added = false;

    for(var i = 0; i < data.length/3; i++)
    {
        // columns
        html += "<tr>";

        for(var j = 0; j < 3; j++)
        {
            if(i+j >= data.length) 
            {
                added = true;
                html += "</tr>";
                parent_table.append(html);
                break;
            }

            //{% static'+ "'"+data[i+j].image+"'"+' %}
            html += '<td>'
            +'<div class="ui link cards">'
              +'<div class="card" contact-id="'+data[i+j].id+'" contact-name="'+data[i+j].name+'"'
              +'contact-img="'+data[i+j].image+'" contact-rating="'+data[i+j].rating+'" contact-categoryId="'+data[i+j].categoryId_id+'">'
                +'<div class="image">'
                  +'<img src="">'
                +'</div>'
                +'<div class="content">'
                  +'<div class="header">'+data[i+j].name+'</div>'
                  +'<div class="meta">'
                    +'<a id="menu" data-id="'+data[i+j].id+'">Menu</a>'
                  +'</div>'
                  +'<div class="description">'
                    +data[i+j].description
                  +'</div>'
                +'</div>'
                +'<div class="extra content">'
                  +'<span class="right floated">'
                    +'<div class="ui star rating" data-rating="'+data[i+j].rating+'" data-max-rating="5"></div>'
                  +'</span>'
                  +'<a id="comment" data-id="'+data[i+j].id+'"><span>'
                    +'<i class="comments icon"></i>'
                    +'Comentarios'
                  +'</span></a>'
                +'</div>'
              +'</div>'
              +'</div>'
              +'</td>'
        }

        html += "</tr>";
    }

    $(".card").click(function(){

        openConctactModal($(this));

    });

    if(!added)
        parent_table.append(html);

    $('.ui.rating').rating();
}

function openConctactModal(obj)
{
    var id = obj.attr("contact-id");
    var name = obj.attr("contact-name");
    var image = obj.attr("contact-img");
    var rating = obj.attr("contact-rating");
    var description = obj.attr("contact-desc");
	var category = obj.attr("categoryId");

    var contactModal = $('.contactModal');

    contactModal.modal("show");

    /*appending data*/
    $('.contactModal .header').html(name);
    $('.image content').find('img').prop('src',image);
    $('.ui header desc').html(description);

	// getting branches

	var dic = {
        csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
		contactId: id
    }

	postData('directories/getContactBranches/',dic,function(data){

       console.log(data);
    });

	$('#sucursal_select').html('');

	$('<option>').val('999').text('999').appendTo('#sucursal_select');
	
}

function postData(url,vars,callback)
{
  $.ajax({
      type:"POST",
          url:url,
          data: vars,
          success: callback
  });

}


